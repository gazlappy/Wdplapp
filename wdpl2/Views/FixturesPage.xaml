<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="Wdpl2.Views.FixturesPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:local="clr-namespace:Wdpl2.Views"
    xmlns:models="clr-namespace:Wdpl2.Models"
    Title="Fixtures"
    AutomationProperties.Name="Fixtures management page">

    <Grid ColumnDefinitions="280,*" RowDefinitions="Auto,*" Padding="8" ColumnSpacing="8" RowSpacing="8">
        
        <!-- OCR Progress Overlay -->
        <Border 
            x:Name="OcrProgressOverlay"
            Grid.Row="0"
            Grid.RowSpan="2"
            Grid.ColumnSpan="2"
            IsVisible="False"
            BackgroundColor="#CC000000"
            ZIndex="200"
            Padding="20">
            <Border 
                BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1F1F1F}"
                StrokeShape="RoundRectangle 16"
                Padding="32"
                HorizontalOptions="Center"
                VerticalOptions="Center"
                WidthRequest="400">
                <VerticalStackLayout Spacing="16" HorizontalOptions="Center">
                    <Label x:Name="OcrProgressTitle" 
                           Text="Processing Score Card" 
                           FontSize="18" 
                           FontAttributes="Bold" 
                           HorizontalTextAlignment="Center" />
                    
                    <ActivityIndicator 
                        x:Name="OcrActivityIndicator"
                        IsRunning="True"
                        Color="{StaticResource PrimaryColor}"
                        HeightRequest="48"
                        WidthRequest="48" />
                    
                    <Label x:Name="OcrProgressMessage" 
                           Text="Analyzing image with OCR..." 
                           FontSize="14" 
                           HorizontalTextAlignment="Center"
                           TextColor="Gray" />
                    
                    <ProgressBar x:Name="OcrProgressBar"
                                 Progress="0"
                                 ProgressColor="{StaticResource PrimaryColor}"
                                 HeightRequest="8" />
                    
                    <Label x:Name="OcrProgressPercent" 
                           Text="0%" 
                           FontSize="12" 
                           HorizontalTextAlignment="Center"
                           TextColor="Gray" />
                </VerticalStackLayout>
            </Border>
        </Border>
        
        <!-- Header with Burger Menu Button -->
        <Grid Grid.ColumnSpan="2" ColumnDefinitions="Auto,*">
            <Button 
                x:Name="BurgerMenuBtn"
                Text="â˜°"
                FontSize="20"
                WidthRequest="40"
                HeightRequest="40"
                Padding="0"
                Margin="0,0,8,0"
                BackgroundColor="{StaticResource PrimaryColor}"
                TextColor="White"
                AutomationProperties.Name="Open menu"
                AutomationProperties.HelpText="Opens the fixtures controls menu" />
            
            <Label 
                Grid.Column="1"
                Text="Manage Fixtures" 
                Style="{StaticResource PageTitleStyle}"
                VerticalOptions="Center"
                AutomationProperties.Name="Manage Fixtures" />
        </Grid>

        <!-- Flyout Menu Overlay -->
        <Border 
            x:Name="FlyoutOverlay"
            Grid.Row="1"
            Grid.ColumnSpan="2"
            IsVisible="False"
            BackgroundColor="#80000000"
            ZIndex="100"
            AutomationProperties.Name="Menu overlay">
            <Border.GestureRecognizers>
                <TapGestureRecognizer x:Name="OverlayTap" />
            </Border.GestureRecognizers>
        </Border>

        <!-- Flyout Menu Panel -->
        <Border 
            x:Name="FlyoutPanel"
            Grid.Row="1"
            Grid.ColumnSpan="2"
            HorizontalOptions="Start"
            WidthRequest="350"
            IsVisible="False"
            BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1F1F1F}"
            Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
            StrokeThickness="1"
            StrokeShape="RoundRectangle 0,12,12,0"
            Padding="12"
            ZIndex="101"
            AutomationProperties.Name="Fixtures controls menu">
            <ScrollView>
                <VerticalStackLayout Spacing="8">
                    
                    <Grid ColumnDefinitions="Auto,*,Auto">
                        <Label Text="Controls" Style="{StaticResource SectionHeaderStyle}" VerticalOptions="Center" Margin="0" />
                        <Button 
                            x:Name="CloseFlyoutBtn"
                            Grid.Column="2"
                            Text="âœ•"
                            FontSize="16"
                            WidthRequest="36"
                            HeightRequest="36"
                            Padding="0"
                            Style="{StaticResource DangerButtonStyle}"
                            CornerRadius="18"
                            AutomationProperties.Name="Close menu" />
                    </Grid>
                    
                    <BoxView HeightRequest="1" Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                    <Label Text="Filters" Style="{StaticResource SubsectionHeaderStyle}" Margin="0" FontSize="13" />

                    <Entry x:Name="SearchEntry" Placeholder="Search..." FontSize="13" AutomationProperties.Name="Search fixtures" />

                    <Picker x:Name="DivisionPicker" Title="All Divisions" ItemDisplayBinding="{Binding Name}" FontSize="13" AutomationProperties.Name="Filter by division" />

                    <DatePicker x:Name="FromDate" FontSize="13" AutomationProperties.Name="Filter from date" />

                    <Grid ColumnDefinitions="*,Auto">
                        <Label Text="Active season only" VerticalOptions="Center" FontSize="12" />
                        <Switch x:Name="ActiveSeasonOnly" Grid.Column="1" IsToggled="True" AutomationProperties.Name="Show active season only" />
                    </Grid>

                    <Border Padding="8" BackgroundColor="{AppThemeBinding Light=#F0F9FF, Dark=#1E3A8A}" StrokeShape="RoundRectangle 6">
                        <Label x:Name="PendingNotificationsLabel" Text="Loading..." FontSize="11" HorizontalTextAlignment="Center" AutomationProperties.Name="Pending notifications count" />
                    </Border>

                    <Label Text="Actions" Style="{StaticResource SubsectionHeaderStyle}" Margin="0,4,0,0" FontSize="13" />

                    <Button x:Name="ScanScoreCardBtn" Text="ðŸ“· Scan Score Card" BackgroundColor="{StaticResource PrimaryColor}" TextColor="White" FontSize="12" HeightRequest="32" AutomationProperties.Name="Scan score card from photo" />
                    <Button x:Name="ManageNotificationsBtn" Text="ðŸ”” Reminders" BackgroundColor="{StaticResource InfoColor}" TextColor="White" FontSize="12" HeightRequest="32" AutomationProperties.Name="Manage reminders" />
                    <Button x:Name="DiagnosticsBtn" Text="ðŸ” Diagnostics" BackgroundColor="{StaticResource Gray600}" TextColor="White" FontSize="12" HeightRequest="32" AutomationProperties.Name="View diagnostics" />
                    <Button x:Name="GenerateFixturesBtn" Text="Generate Fixtures" Style="{StaticResource SuccessButtonStyle}" FontSize="12" HeightRequest="32" AutomationProperties.Name="Generate fixtures" />
                    <Button x:Name="DeleteSeasonBtn" Text="Delete (Season)" Style="{StaticResource WarningButtonStyle}" FontSize="12" HeightRequest="32" AutomationProperties.Name="Delete season fixtures" />
                    <Button x:Name="DeleteAllBtn" Text="Delete ALL" Style="{StaticResource DangerButtonStyle}" FontSize="12" HeightRequest="32" AutomationProperties.Name="Delete all fixtures" />
                    
                </VerticalStackLayout>
            </ScrollView>
        </Border>

        <!-- LEFT: Fixtures List -->
        <Border 
            Grid.Row="1"
            Grid.Column="0"
            StrokeShape="RoundRectangle 8" 
            Padding="8"
            BackgroundColor="{AppThemeBinding Light=#FAFAFA, Dark=#1A1A1A}"
            Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
            StrokeThickness="1"
            AutomationProperties.Name="Fixtures list panel">
            <Grid RowDefinitions="Auto,*" RowSpacing="6">
                <Label Text="Fixtures" FontAttributes="Bold" FontSize="14" Margin="0" />
                
                <CollectionView
                    x:Name="FixturesList"
                    Grid.Row="1"
                    SelectionMode="Single"
                    VerticalScrollBarVisibility="Always"
                    AutomationProperties.Name="Fixtures list">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="local:FixturesPage+FixtureListItem">
                            <Border
                                Padding="6"
                                Margin="0,0,0,3"
                                BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2A2A2A}"
                                StrokeThickness="0"
                                StrokeShape="RoundRectangle 6">
                                <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="6">
                                    <Label 
                                        FontAttributes="Bold"
                                        FontSize="10"
                                        Text="{Binding Date, StringFormat='{0:ddd dd MMM}'}"
                                        VerticalOptions="Center" />

                                    <VerticalStackLayout Grid.Column="1" Spacing="1">
                                        <Label FontAttributes="Bold" FontSize="12" Text="{Binding Title}" LineBreakMode="TailTruncation" />
                                        <Label FontSize="10" TextColor="Gray" Text="{Binding Subtitle}" LineBreakMode="TailTruncation" />
                                    </VerticalStackLayout>
                                    
                                    <Label Grid.Column="2" Text="ðŸ””" FontSize="12" VerticalOptions="Center" IsVisible="{Binding HasReminder}" />
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                    <CollectionView.EmptyView>
                        <Label Text="No fixtures found" FontSize="12" TextColor="Gray" HorizontalTextAlignment="Center" VerticalOptions="Center" />
                    </CollectionView.EmptyView>
                </CollectionView>
            </Grid>
        </Border>

        <!-- RIGHT: Scorecard Editor (WDPL Style) -->
        <Border 
            Grid.Row="1" 
            Grid.Column="1"
            StrokeShape="RoundRectangle 8" 
            Padding="0"
            BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1A1A1A}"
            Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
            StrokeThickness="1"
            AutomationProperties.Name="Scorecard editor">
            
            <Grid RowDefinitions="Auto,Auto,*,Auto">
                
                <!-- Scorecard Header -->
                <VerticalStackLayout Grid.Row="0" Spacing="0">
                    <!-- League Title Bar -->
                    <Border BackgroundColor="#1A1A1A" Padding="8,4">
                        <Grid ColumnDefinitions="*,Auto,Auto,Auto">
                            <Label Text="WELLINGTON &amp; DISTRICT POOL LEAGUE" 
                                   FontAttributes="Bold,Italic" 
                                   FontSize="13" 
                                   TextColor="White"
                                   VerticalOptions="Center" />
                            <Label x:Name="DivisionLabel" 
                                   Grid.Column="1" 
                                   Text="Div." 
                                   FontSize="12" 
                                   TextColor="White"
                                   VerticalOptions="Center"
                                   Margin="12,0,0,0" />
                            <Label x:Name="DateLabel" 
                                   Grid.Column="2" 
                                   Text="Date" 
                                   FontSize="12" 
                                   TextColor="White"
                                   VerticalOptions="Center"
                                   Margin="12,0,0,0" />
                            <Label x:Name="ScoreLbl" 
                                   Grid.Column="3" 
                                   Text="" 
                                   FontSize="14" 
                                   FontAttributes="Bold"
                                   TextColor="#FFD700"
                                   VerticalOptions="Center"
                                   Margin="12,0,0,0" />
                        </Grid>
                    </Border>
                    
                    <!-- Team Names Header - matches scorecard columns -->
                    <Grid ColumnDefinitions="120,30,*,36,36,*,36" BackgroundColor="#1A1A1A" Padding="0">
                        <Border Grid.Column="0" BackgroundColor="#333333" Padding="6,4">
                            <Label x:Name="HomeTeamHeader" Text="Home Team" FontAttributes="Bold" FontSize="11" TextColor="White" LineBreakMode="TailTruncation" />
                        </Border>
                        <Border Grid.Column="1" BackgroundColor="#1A1A1A" Padding="2,4">
                            <Label Text="#" FontAttributes="Bold" FontSize="11" TextColor="White" HorizontalTextAlignment="Center" />
                        </Border>
                        <Border Grid.Column="2" BackgroundColor="#1A1A1A" Padding="4,4">
                            <Label Text="Home Player" FontAttributes="Bold" FontSize="11" TextColor="White" HorizontalTextAlignment="Center" />
                        </Border>
                        <Border Grid.Column="3" Grid.ColumnSpan="2" BackgroundColor="#1A1A1A" Padding="2,4">
                            <Label Text="Score" FontAttributes="Bold" FontSize="11" TextColor="White" HorizontalTextAlignment="Center" />
                        </Border>
                        <Border Grid.Column="5" BackgroundColor="#1A1A1A" Padding="4,4">
                            <Label Text="Away Player" FontAttributes="Bold" FontSize="11" TextColor="White" HorizontalTextAlignment="Center" />
                        </Border>
                        <Border Grid.Column="6" BackgroundColor="#333333" Padding="2,4">
                            <Label Text="8" FontAttributes="Bold" FontSize="11" TextColor="White" HorizontalTextAlignment="Center" />
                        </Border>
                    </Grid>
                    
                    <!-- Second header row with away team name -->
                    <Grid ColumnDefinitions="120,30,*,36,36,*,36" BackgroundColor="#1A1A1A" Padding="0">
                        <Border Grid.Column="0" BackgroundColor="#333333" Padding="6,2">
                            <Label Text="Full names only" FontSize="9" TextColor="#FFD700" />
                        </Border>
                        <Border Grid.Column="2" Grid.ColumnSpan="4" BackgroundColor="#1A1A1A" Padding="4,2">
                            <Label Text="Away captain to ensure no repeat pairings" FontSize="9" TextColor="#FFD700" HorizontalTextAlignment="Center" />
                        </Border>
                        <Border Grid.Column="6" BackgroundColor="#333333" Padding="2,2">
                            <Label x:Name="AwayTeamHeader" Text="Away" FontSize="9" TextColor="White" HorizontalTextAlignment="Center" LineBreakMode="TailTruncation" />
                        </Border>
                    </Grid>
                </VerticalStackLayout>

                <!-- Current Frame Indicator -->
                <Border Grid.Row="1" 
                        Padding="6,4" 
                        BackgroundColor="{AppThemeBinding Light=#E8F5E9, Dark=#1B5E20}"
                        IsVisible="False"
                        x:Name="CurrentFrameIndicator"
                        AutomationProperties.Name="Current frame indicator">
                    <HorizontalStackLayout Spacing="6" HorizontalOptions="Center">
                        <Label Text="â–¶" FontSize="12" TextColor="{AppThemeBinding Light=#2E7D32, Dark=#81C784}" VerticalOptions="Center" />
                        <Label x:Name="CurrentFrameLabel" Text="Frame 1 - Select HOME player" FontSize="12" FontAttributes="Bold" TextColor="{AppThemeBinding Light=#2E7D32, Dark=#81C784}" VerticalOptions="Center" />
                    </HorizontalStackLayout>
                </Border>

                <!-- Main Content: Player Lists + Scorecard -->
                <ScrollView Grid.Row="2">
                    <Grid ColumnDefinitions="120,*,120" ColumnSpacing="0">
                        
                        <!-- LEFT: Home Team Player List -->
                        <Border Grid.Column="0" 
                                BackgroundColor="{AppThemeBinding Light=#E3F2FD, Dark=#0D47A1}"
                                Padding="0"
                                AutomationProperties.Name="Home team players">
                            <VerticalStackLayout>
                                <Border BackgroundColor="{AppThemeBinding Light=#1976D2, Dark=#1565C0}" Padding="6,4">
                                    <Label x:Name="HomeTeamListHeader" Text="HOME" FontSize="10" FontAttributes="Bold" TextColor="White" HorizontalTextAlignment="Center" />
                                </Border>
                                <!-- Quick key buttons generated programmatically -->
                                <VerticalStackLayout x:Name="HomePlayersQuickPanel" Spacing="2" Padding="2" />
                            </VerticalStackLayout>
                        </Border>
                        
                        <!-- CENTER: Scorecard Grid -->
                        <VerticalStackLayout Grid.Column="1" x:Name="ScorecardHost" Spacing="0" AutomationProperties.Name="Scorecard frames">
                            <!-- Frame rows will be injected here programmatically -->
                        </VerticalStackLayout>
                        
                        <!-- RIGHT: Away Team Player List -->
                        <Border Grid.Column="2" 
                                BackgroundColor="{AppThemeBinding Light=#FFEBEE, Dark=#B71C1C}"
                                Padding="0"
                                AutomationProperties.Name="Away team players">
                            <VerticalStackLayout>
                                <Border BackgroundColor="{AppThemeBinding Light=#D32F2F, Dark=#C62828}" Padding="6,4">
                                    <Label x:Name="AwayTeamListHeader" Text="AWAY" FontSize="10" FontAttributes="Bold" TextColor="White" HorizontalTextAlignment="Center" />
                                </Border>
                                <!-- Quick key buttons generated programmatically -->
                                <VerticalStackLayout x:Name="AwayPlayersQuickPanel" Spacing="2" Padding="2" />
                            </VerticalStackLayout>
                        </Border>
                        
                    </Grid>
                </ScrollView>

                <!-- Bottom: Actions & Status -->
                <Border Grid.Row="3" Padding="8,6" BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2A2A2A}">
                    <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto" ColumnSpacing="8">
                        <Label x:Name="ReminderStatusLabel" Text="" FontSize="10" VerticalOptions="Center" TextColor="Gray" AutomationProperties.Name="Reminder status" />
                        
                        <!-- Hidden Entry for keyboard capture -->
                        <Entry x:Name="KeyboardCaptureEntry" 
                               Grid.Column="1"
                               WidthRequest="1" 
                               HeightRequest="1"
                               Opacity="0.01"
                               Keyboard="Text"
                               Placeholder=""
                               AutomationProperties.Name="Keyboard input" />
                        
                        <Button x:Name="ClearBtn" Grid.Column="2" Text="Clear" Style="{StaticResource SecondaryButtonStyle}" HeightRequest="30" FontSize="11" Padding="12,0" AutomationProperties.Name="Clear scorecard" />
                        <Button x:Name="SaveBtn" Grid.Column="3" Text="ðŸ’¾ Save" Style="{StaticResource SuccessButtonStyle}" HeightRequest="30" FontSize="11" Padding="12,0" AutomationProperties.Name="Save fixture" />
                        <Label x:Name="HeaderLbl" Grid.Column="4" Text="Select a fixture" FontSize="10" VerticalOptions="Center" TextColor="Gray" AutomationProperties.Name="Status" />
                    </Grid>
                </Border>
                
            </Grid>
        </Border>
    </Grid>
</ContentPage>