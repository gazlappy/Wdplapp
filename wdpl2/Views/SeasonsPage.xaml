<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="Wdpl2.Views.SeasonsPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:models="clr-namespace:Wdpl2.Models"
    Title="Seasons"
    AutomationProperties.Name="Seasons management page">

    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,*" Padding="12" ColumnSpacing="12" RowSpacing="12">
        
        <!-- Header with Burger Menu Button -->
        <Grid Grid.ColumnSpan="2" ColumnDefinitions="Auto,*">
            <Button 
                x:Name="BurgerMenuBtn"
                Text="â˜°"
                FontSize="24"
                WidthRequest="50"
                HeightRequest="50"
                Padding="0"
                Margin="0,0,12,0"
                BackgroundColor="{StaticResource PrimaryColor}"
                TextColor="White"
                AutomationProperties.Name="Open menu"
                AutomationProperties.HelpText="Opens the season controls menu" />
            
            <Label 
                Grid.Column="1"
                Text="Manage Seasons" 
                Style="{StaticResource PageTitleStyle}"
                VerticalOptions="Center"
                AutomationProperties.Name="Manage Seasons" />
        </Grid>

        <!-- Flyout Menu Overlay -->
        <Border 
            x:Name="FlyoutOverlay"
            Grid.Row="1"
            Grid.ColumnSpan="2"
            IsVisible="False"
            BackgroundColor="#80000000"
            ZIndex="100"
            AutomationProperties.Name="Menu overlay">
            <Border.GestureRecognizers>
                <TapGestureRecognizer x:Name="OverlayTap" />
            </Border.GestureRecognizers>
        </Border>

        <!-- Flyout Menu Panel -->
        <Border 
            x:Name="FlyoutPanel"
            Grid.Row="1"
            Grid.ColumnSpan="2"
            HorizontalOptions="Start"
            WidthRequest="400"
            IsVisible="False"
            BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1F1F1F}"
            Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
            StrokeThickness="1"
            StrokeShape="RoundRectangle 0,12,12,0"
            Padding="{StaticResource LargePadding}"
            ZIndex="101"
            AutomationProperties.Name="Season controls menu">
            <ScrollView>
                <Grid
                    RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto,Auto"
                    ColumnDefinitions="Auto,*"
                    ColumnSpacing="{StaticResource MediumSpacing}"
                    RowSpacing="{StaticResource StandardSpacing}">

                    <HorizontalStackLayout Grid.ColumnSpan="2" Spacing="{StaticResource StandardSpacing}">
                        <Label Text="Controls" Style="{StaticResource SectionHeaderStyle}" VerticalOptions="Center" Margin="0" />
                        <Button 
                            x:Name="CloseFlyoutBtn"
                            Text="âœ•"
                            FontSize="18"
                            WidthRequest="40"
                            HeightRequest="40"
                            Padding="0"
                            HorizontalOptions="EndAndExpand"
                            Style="{StaticResource DangerButtonStyle}"
                            CornerRadius="20"
                            AutomationProperties.Name="Close menu" />
                    </HorizontalStackLayout>
                    
                    <BoxView Grid.Row="1" Grid.ColumnSpan="2" HeightRequest="1" Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" />

                    <Label Grid.Row="2" Grid.ColumnSpan="2" Text="Season Details" Style="{StaticResource SubsectionHeaderStyle}" Margin="0" />

                    <Label Grid.Row="3" Grid.Column="0" Text="Name:" Style="{StaticResource FieldLabelStyle}" Margin="0"/>
                    <Entry x:Name="NameEntry" Grid.Row="3" Grid.Column="1" Placeholder="e.g. Winter 2025" AutomationProperties.Name="Season name" />

                    <Label Grid.Row="4" Grid.Column="0" Text="Start date:" Style="{StaticResource FieldLabelStyle}" Margin="0"/>
                    <DatePicker x:Name="StartPicker" Grid.Row="4" Grid.Column="1" AutomationProperties.Name="Season start date" />

                    <Label Grid.Row="5" Grid.Column="0" Text="End date:" Style="{StaticResource FieldLabelStyle}" Margin="0"/>
                    <DatePicker x:Name="EndPicker" Grid.Row="5" Grid.Column="1" AutomationProperties.Name="Season end date" />

                    <Label Grid.Row="6" Grid.Column="0" Text="Active:" Style="{StaticResource FieldLabelStyle}" Margin="0"/>
                    <Switch x:Name="ActiveSwitch" Grid.Row="6" Grid.Column="1" AutomationProperties.Name="Season is active" />

                    <Label Grid.Row="7" Grid.ColumnSpan="2" Text="Actions" Style="{StaticResource SubsectionHeaderStyle}" Margin="0,8,0,0" />

                    <HorizontalStackLayout Grid.Row="8" Grid.ColumnSpan="2" Spacing="{StaticResource StandardSpacing}">
                        <Button x:Name="SaveBtn" Text="Save" Clicked="OnSaveClicked" Style="{StaticResource PrimaryButtonStyle}" AutomationProperties.Name="Save season" />
                        <Button x:Name="DeleteBtn" Text="Delete" Clicked="OnDeleteClicked" Style="{StaticResource DangerButtonStyle}" AutomationProperties.Name="Delete season" />
                    </HorizontalStackLayout>

                    <HorizontalStackLayout Grid.Row="9" Grid.ColumnSpan="2" Spacing="{StaticResource StandardSpacing}">
                        <Button x:Name="SetActiveBtn" Text="Set Active" Clicked="OnSetActiveClicked" Style="{StaticResource SuccessButtonStyle}" AutomationProperties.Name="Set as active season" />
                        <Button x:Name="GenerateBtn" Text="Generate Fixtures" Clicked="OnGenerateClicked" AutomationProperties.Name="Generate fixtures" />
                    </HorizontalStackLayout>

                    <Button x:Name="ImportHistoricalBtn" 
                            Grid.Row="10"
                            Grid.ColumnSpan="2"
                            Text="ðŸ“‹ Import from Previous Seasons" 
                            Clicked="OnImportHistoricalClicked"
                            BackgroundColor="{StaticResource WarningColor}"
                            TextColor="White"
                            AutomationProperties.Name="Import from previous seasons" />
                    
                    <Button x:Name="FixDataBtn" 
                            Grid.Row="11"
                            Grid.ColumnSpan="2"
                            Text="ðŸ”§ Fix Missing Season IDs" 
                            Clicked="OnFixMissingSeasonIdsClicked"
                            BackgroundColor="#FF6B00"
                            TextColor="White"
                            AutomationProperties.Name="Fix missing season IDs" />

                    <Button x:Name="FixVbaDateBtn" 
                            Grid.Row="12"
                            Grid.ColumnSpan="2"
                            Text="ðŸ“… Fix Fixture Dates (from VBA)" 
                            Clicked="OnFixVbaFixtureDatesClicked"
                            BackgroundColor="#2563EB"
                            TextColor="White"
                            AutomationProperties.Name="Fix fixture dates from VBA data" />
                        
                    <BoxView Grid.Row="13" Grid.ColumnSpan="2" HeightRequest="1" 
                             Color="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}" 
                             Margin="0,12" />

                    <VerticalStackLayout Grid.Row="14" Grid.ColumnSpan="2" Spacing="{StaticResource StandardSpacing}">
                        <Label Text="Exclusion Dates" Style="{StaticResource SubsectionHeaderStyle}" Margin="0" />
                        
                        <Label Text="Dates when matches should not be scheduled:" 
                               Style="{StaticResource CaptionStyle}" />

                        <HorizontalStackLayout Spacing="{StaticResource StandardSpacing}">
                            <DatePicker x:Name="ExclusionDatePicker" 
                                       HorizontalOptions="FillAndExpand"
                                       AutomationProperties.Name="Exclusion date to add" />
                            <Button x:Name="AddExclusionBtn" 
                                   Text="+ Add" 
                                   Clicked="OnAddExclusionClicked"
                                   Style="{StaticResource PrimaryButtonStyle}"
                                   AutomationProperties.Name="Add exclusion date" />
                        </HorizontalStackLayout>

                        <Border 
                            Style="{StaticResource CardBorderStyle}"
                            HeightRequest="120">
                            <CollectionView x:Name="ExclusionDatesList" SelectionMode="None" VerticalScrollBarVisibility="Always" AutomationProperties.Name="Exclusion dates list">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="{x:Type x:String}">
                                        <Border
                                            Padding="{StaticResource StandardPadding}"
                                            Margin="0,0,0,4"
                                            BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2A2A2A}"
                                            StrokeThickness="0"
                                            StrokeShape="RoundRectangle 6">
                                            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="{StaticResource StandardSpacing}">
                                                <Label Text="{Binding}" 
                                                       VerticalOptions="Center"
                                                       FontSize="12" />
                                                <Button Grid.Column="1" 
                                                       Text="Remove" 
                                                       FontSize="11"
                                                       Padding="6,3"
                                                       Clicked="OnRemoveExclusionClicked"
                                                       CommandParameter="{Binding}"
                                                       Style="{StaticResource DangerButtonStyle}"
                                                       CornerRadius="4"
                                                       AutomationProperties.Name="Remove exclusion date" />
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                                <CollectionView.EmptyView>
                                    <Label Text="No exclusion dates" 
                                           Style="{StaticResource CaptionStyle}"
                                           HorizontalOptions="Center" 
                                           VerticalOptions="Center" />
                                </CollectionView.EmptyView>
                            </CollectionView>
                        </Border>

                        <Label x:Name="StatusLabel" Style="{StaticResource StatusTextStyle}" AutomationProperties.Name="Status message" />
                    </VerticalStackLayout>
                    
                </Grid>
            </ScrollView>
        </Border>

        <!-- LEFT: Season list -->
        <Border 
            Grid.Row="1"
            Grid.Column="0"
            StrokeShape="RoundRectangle 12" 
            Padding="{StaticResource MediumPadding}"
            BackgroundColor="{AppThemeBinding Light=#FAFAFA, Dark=#1A1A1A}"
            Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
            StrokeThickness="1"
            AutomationProperties.Name="Seasons list panel">
            <Grid RowDefinitions="Auto,*,Auto" RowSpacing="{StaticResource StandardSpacing}">
                <Label Text="Seasons" Style="{StaticResource SectionHeaderStyle}" Margin="0" />
                <CollectionView
                    Grid.Row="1"
                    x:Name="SeasonsList"
                    SelectionMode="Single"
                    SelectionChanged="OnSelectionChanged"
                    VerticalScrollBarVisibility="Always"
                    AutomationProperties.Name="Seasons list">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Season">
                            <Border
                                Padding="{StaticResource StandardPadding}"
                                Margin="0,0,0,4"
                                BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2A2A2A}"
                                StrokeThickness="0"
                                StrokeShape="RoundRectangle 8">
                                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                    <Label
                                        Text="{Binding Name}"
                                        FontSize="14"
                                        FontAttributes="Bold"
                                        LineBreakMode="TailTruncation"
                                        VerticalOptions="Center" />
                                    <Ellipse
                                        Grid.Column="1"
                                        WidthRequest="12"
                                        HeightRequest="12"
                                        VerticalOptions="Center">
                                        <Ellipse.Fill>
                                            <SolidColorBrush Color="{Binding IsActive, Converter={StaticResource BoolToColorConverter}}" />
                                        </Ellipse.Fill>
                                    </Ellipse>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                <HorizontalStackLayout Grid.Row="2" Spacing="8">
                    <Button 
                        x:Name="RefreshListBtn"
                        Text="ðŸ”„ Refresh" 
                        Clicked="OnRefreshListClicked"
                        HorizontalOptions="FillAndExpand"
                        AutomationProperties.Name="Refresh seasons list" />
                    <Button 
                        Text="+ New Season" 
                        Clicked="OnNewClicked" 
                        Style="{StaticResource PrimaryButtonStyle}"
                        HorizontalOptions="FillAndExpand"
                        AutomationProperties.Name="Create new season" />
                </HorizontalStackLayout>
            </Grid>
        </Border>

        <!-- RIGHT: Season Info Panel -->
        <Border 
            Grid.Row="1" 
            Grid.Column="1"
            StrokeShape="RoundRectangle 12" 
            Padding="{StaticResource MediumPadding}"
            BackgroundColor="{AppThemeBinding Light=#FAFAFA, Dark=#1A1A1A}"
            Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
            StrokeThickness="1"
            AutomationProperties.Name="Season details panel">
            <ScrollView>
                <VerticalStackLayout Spacing="{StaticResource MediumSpacing}">
                    
                    <!-- Empty State -->
                    <VerticalStackLayout 
                        x:Name="EmptyStatePanel"
                        Spacing="{StaticResource MediumSpacing}"
                        HorizontalOptions="Center"
                        VerticalOptions="Center"
                        Padding="40"
                        IsVisible="True"
                        AutomationProperties.Name="No season selected">
                        <Label 
                            Text="ðŸ“…"
                            FontSize="48"
                            HorizontalOptions="Center" />
                        <Label 
                            Text="Select a season"
                            FontSize="18"
                            FontAttributes="Bold"
                            TextColor="{StaticResource Gray600}"
                            HorizontalOptions="Center" />
                        <Label 
                            Text="Click a season from the list to view details and statistics"
                            Style="{StaticResource CaptionStyle}"
                            HorizontalTextAlignment="Center"
                            HorizontalOptions="Center" />
                    </VerticalStackLayout>

                    <!-- Season Info Panel (initially hidden) -->
                    <VerticalStackLayout x:Name="SeasonInfoPanel" IsVisible="False" Spacing="16" AutomationProperties.Name="Selected season details">
                        
                        <!-- Header -->
                        <VerticalStackLayout Spacing="4">
                            <Label x:Name="SelectedSeasonName" 
                                   Style="{StaticResource PageTitleStyle}" 
                                   Margin="0" />
                            <Label x:Name="SelectedSeasonDates" 
                                   Style="{StaticResource BodyTextStyle}"
                                   TextColor="{StaticResource Gray600}" />
                            <Border x:Name="SelectedSeasonStatusBadge"
                                    Style="{StaticResource SuccessBadgeStyle}"
                                    HorizontalOptions="Start"
                                    Margin="0,4,0,0">
                                <Label x:Name="SelectedSeasonStatus" 
                                       Style="{StaticResource BadgeTextStyle}" />
                            </Border>
                        </VerticalStackLayout>

                        <BoxView HeightRequest="1" Color="{StaticResource Gray200}" />

                        <!-- Statistics Grid -->
                        <Label Text="Statistics" 
                               Style="{StaticResource SectionHeaderStyle}"
                               Margin="0,8,0,8" />

                        <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto,Auto" 
                              ColumnSpacing="12" RowSpacing="12">
                            
                            <!-- Divisions Card -->
                            <Border Grid.Column="0" Grid.Row="0"
                                    Style="{StaticResource CardBorderStyle}"
                                    BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2A2A2A}">
                                <VerticalStackLayout Padding="16" Spacing="4">
                                    <Label Text="ðŸ“Š" FontSize="24" HorizontalOptions="Center" />
                                    <Label x:Name="DivisionsCount" 
                                           Text="0"
                                           FontSize="32"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource PrimaryColor}"
                                           HorizontalOptions="Center" />
                                    <Label Text="Divisions" 
                                           Style="{StaticResource CaptionStyle}"
                                           HorizontalOptions="Center" />
                                </VerticalStackLayout>
                            </Border>

                            <!-- Teams Card -->
                            <Border Grid.Column="1" Grid.Row="0"
                                    Style="{StaticResource CardBorderStyle}"
                                    BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2A2A2A}">
                                <VerticalStackLayout Padding="16" Spacing="4">
                                    <Label Text="ðŸ‘¥" FontSize="24" HorizontalOptions="Center" />
                                    <Label x:Name="TeamsCount" 
                                           Text="0"
                                           FontSize="32"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource InfoColor}"
                                           HorizontalOptions="Center" />
                                    <Label Text="Teams" 
                                           Style="{StaticResource CaptionStyle}"
                                           HorizontalOptions="Center" />
                                </VerticalStackLayout>
                            </Border>

                            <!-- Players Card -->
                            <Border Grid.Column="0" Grid.Row="1"
                                    Style="{StaticResource CardBorderStyle}"
                                    BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2A2A2A}">
                                <VerticalStackLayout Padding="16" Spacing="4">
                                    <Label Text="ðŸŽ¯" FontSize="24" HorizontalOptions="Center" />
                                    <Label x:Name="PlayersCount" 
                                           Text="0"
                                           FontSize="32"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource SuccessColor}"
                                           HorizontalOptions="Center" />
                                    <Label Text="Players" 
                                           Style="{StaticResource CaptionStyle}"
                                           HorizontalOptions="Center" />
                                </VerticalStackLayout>
                            </Border>

                            <!-- Fixtures Card -->
                            <Border Grid.Column="1" Grid.Row="1"
                                    Style="{StaticResource CardBorderStyle}"
                                    BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2A2A2A}">
                                <VerticalStackLayout Padding="16" Spacing="4">
                                    <Label Text="ðŸ“…" FontSize="24" HorizontalOptions="Center" />
                                    <Label x:Name="FixturesCount" 
                                           Text="0"
                                           FontSize="32"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource WarningColor}"
                                           HorizontalOptions="Center" />
                                    <Label Text="Fixtures" 
                                           Style="{StaticResource CaptionStyle}"
                                           HorizontalOptions="Center" />
                                </VerticalStackLayout>
                            </Border>

                            <!-- Venues Card -->
                            <Border Grid.Column="0" Grid.Row="2"
                                    Style="{StaticResource CardBorderStyle}"
                                    BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2A2A2A}">
                                <VerticalStackLayout Padding="16" Spacing="4">
                                    <Label Text="ðŸ " FontSize="24" HorizontalOptions="Center" />
                                    <Label x:Name="VenuesCount" 
                                           Text="0"
                                           FontSize="32"
                                           FontAttributes="Bold"
                                           TextColor="#8B5CF6"
                                           HorizontalOptions="Center" />
                                    <Label Text="Venues" 
                                           Style="{StaticResource CaptionStyle}"
                                           HorizontalOptions="Center" />
                                </VerticalStackLayout>
                            </Border>

                            <!-- Competitions Card -->
                            <Border Grid.Column="1" Grid.Row="2"
                                    Style="{StaticResource CardBorderStyle}"
                                    BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#2A2A2A}">
                                <VerticalStackLayout Padding="16" Spacing="4">
                                    <Label Text="ðŸ†" FontSize="24" HorizontalOptions="Center" />
                                    <Label x:Name="CompetitionsCount" 
                                           Text="0"
                                           FontSize="32"
                                           FontAttributes="Bold"
                                           TextColor="#EC4899"
                                           HorizontalOptions="Center" />
                                    <Label Text="Competitions" 
                                           Style="{StaticResource CaptionStyle}"
                                           HorizontalOptions="Center" />
                                </VerticalStackLayout>
                            </Border>
                        </Grid>

                        <BoxView HeightRequest="1" Color="{StaticResource Gray200}" Margin="0,8" />

                        <!-- Quick Actions -->
                        <Label Text="Quick Actions" 
                               Style="{StaticResource SectionHeaderStyle}"
                               Margin="0,0,0,8" />

                        <Button Text="Edit Season Details"
                                Clicked="OnBurgerMenuClicked"
                                Style="{StaticResource PrimaryButtonStyle}"
                                HorizontalOptions="Fill"
                                AutomationProperties.Name="Edit season details" />

                        <Button Text="Generate Fixtures"
                                Clicked="OnGenerateClicked"
                                Style="{StaticResource SecondaryButtonStyle}"
                                HorizontalOptions="Fill"
                                AutomationProperties.Name="Generate fixtures for season" />

                    </VerticalStackLayout>

                </VerticalStackLayout>
            </ScrollView>
        </Border>
    </Grid>
</ContentPage>
